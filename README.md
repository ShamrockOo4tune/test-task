# test-task  

# Структура репозитория:  

.  
├── ansible  
│   ├── ansible.cfg  
│   ├── configure_server  
│   │   ├── defaults  
│   │   │   └── main.yml  
│   │   ├── handlers  
│   │   │   └── main.yml  
│   │   ├── README.md  
│   │   ├── tasks  
│   │   │   └── main.yml  
│   │   ├── templates  
│   │   │   └── users.txt.j2  
│   │   └── vars  
│   │       └── main.yml  
│   ├── configure_server.yaml  
│   ├── group_vars  
│   │   └── end_servers  
│   ├── hosts  
│   ├── install_software  
│   │   ├── defaults  
│   │   │   └── main.yml  
│   │   ├── README.md  
│   │   ├── tasks  
│   │   │   └── main.yml  
│   │   └── vars  
│   │       └── main.yml  
│   └── install_software.yaml  
├── create_vms.sh  
├── README.md &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <--- Вы здесь           
├── screenshots-and-logfiles  
│   ├── ansible.log  
│   ├── ansible_on_DHCP01.png  
│   └── vbox_network_solved.png  
├── setup_DHCP01.sh  
└── tasks.txt  
└── terraform  
    ├── example-credentials.auto.tfvars  
    ├── examples  
    │   ├── network  
    │   │   ├── example-credentials.auto.tfvars -> ../../example-credentials.auto.tfvars  
    │   │   ├── link_to_backend.auto.tfvars -> ../remote-state/backend.auto.tfvars  
    │   │   ├── main.tf  
    │   │   ├── outputs.tf  
    │   │   └── variables.tf  
    │   ├── remote-state  
    │   │   ├── example-credentials.auto.tfvars -> ../../example-credentials.auto.tfvars  
    │   │   ├── main.tf.init  
    │   │   ├── main.tf.swith-to-remote  
    │   │   └── variables.tf  
    │   ├── security_groups  
    │   │   ├── example-credentials.auto.tfvars -> ../../example-credentials.auto.tfvars  
    │   │   ├── link_to_backend.auto.tfvars -> ../remote-state/backend.auto.tfvars  
    │   │   ├── main.tf  
    │   │   └── variables.tf  
    │   └── webserver  
    │       ├── data.tf  
    │       ├── example-credentials.auto.tfvars -> ../../example-credentials.auto.tfvars  
    │       ├── link_to_backend.auto.tfvars -> ../remote-state/backend.auto.tfvars  
    │       ├── main.tf  
    │       ├── meta.tftpl  
    │       ├── outputs.tf  
    │       ├── variables.tf  
    └── modules  
        ├── network  
        │   ├── locals.tf  
        │   ├── main.tf  
        │   ├── outputs.tf  
        │   └── variables.tf  
        ├── remote_state  
        │   ├── locals.tf    
        │   ├── main.tf  
        │   ├── outputs.tf  
        │   └── variables.tf  
        ├── security_groups  
        │   ├── locals.tf  
        │   ├── main.tf  
        │   ├── outputs.tf  
        │   └── variables.tf  
        └── webserver  
            ├── locals.tf  
            ├── main.tf  
            ├── outputs.tf  
            └── variables.tf  

# Тестовое задание для Innostage  

Исходные данные представлены в файле: tasks.txt  в корне репозитория


# Воспроизведение решения

# Ansible
При установленной системе виртуализации VirtualBox, запустить сценарий create_vms.sh в корне репозитория  
Установить ОС на вируальных машинах SRV01 и DHCP01. На сервере SRV01 создать технического пользователя  
ansible с административными правами. Добавить пользователя в sudoers (nopasswd all)
Активировать сетевые интерфесы и установить их автоматическое подключение при загрузке

На хосте dhcp01: Добавить пользователя в sudoers (nopasswd all)
Активировать сетевые интерфесы и установить их автоматическое подключение при загрузке

Сверить IP адреса. Скорректировать IP в сценарии
Выполнить установочный сценарий setup_DHCP01.sh на виртуальной машине DHCP01  
Будет запрошен пароль пользователя ansible@SRV01 для проброса внутрь открытого ключа  

Скорректировать hosts c учетом IP адреса SRV01
Тем же пользователем, который исполнял  setup_DHCP01.sh на виртуальной машине DHCP01 запустить выполнение  
сценария ansible-playbook, расположенного по пути ~/test-task/ansible/install_software.yaml  

Затем можно будет запустить следующий сценарий (configure_server) там же  

Наблюдать результаты на экране

# Примеры выполнения задания
Доступны снимки экрана и файл логов в папке screenshots-and-logfiles в корне проекта

# Terraform  
Создание необходимой инфраструктуры декомпозировано на отдельные модули:  
  - создание сервисной учетной записи, ключей, удалленного хранилища состояния (модуль remote state)   
  - создание сети, подсети  
  - создание контрольной группы и правил  
  - создание вебсервера  
Передача данных меду модулями организована через outputs в remote state  

Для решения задания созданы модули-образцы (папка examples)  

# Воспроизведение решения  

В файле example-credentials вписать и раскомментировать строки с учетными данными или организовать их передачу в модуль другим подходящим способом  
Перейти в модуль terraform/examples/remote-state . Переименовать main.tf.init в main.tf. Инициализировать (terraform init).   
Будет сгенерирован файл backend.auto.tfvars для инициализации и связи других модулей инфраструктуры.   
Произвести разворачивание инфраструктуры terraform  apply  
Переименовать main.tf (изменить произвольно окончание имени (расширение)) и main.tf.switch-to-remote в main.tf  
Произвести переключение на удаленное хранение состояния (remote state)   
$ terraform init -remote-config=backend.auto.tfvars     

Перейти последовательно в модули network, security_groups, webserver    
Произвести инициализацию 
( $ terraform init -remote-config=backend.auto.tfvars )
и разворачивание в каждом модуле  
При выполнении модуля webserver в результаты выводится публичный IP адрес вебсервера, URL со страницей заглушкой   


#
# Проектирование инфраструктуры  
#

Для организации системы автоматического распространения обновлений, декомпозируем задачу
1. сбор данных о наличии новых обновлений (версий програмного обеспечения), копирование найденных новых обновлений в хранилище пакетов
2. создание списков пакетов (ОС + ПО) с указанием версий которые необходимо протестировать. Список пакетов создается на каждый сервис и компонент сервиса
3. запуск вм с конфигурацией (список п.2)
4. тесты работоспособности машины (п.3)
5. принятие решения об обновлении продуктовых машин, обновление продуктовых машин
6. версионированное хранение конфигураций (список пакетов)
7. сохранение данных работы процессов (пп 1-6) в бд , логов - в хранилище 

Оркестрировать эти процессы предлагаю Apache Airflow.   
Сами пакеты хранить в S3 образном хранилище  
Версионированные конфигурации инстансов сервисов в Gitlab. Текущие конфигурации - там же.  
Обновление конфигураций через PR. Прямые коммиты запрещены. Условие смерживания изменений - прилет вебхука (специально оформленного коммента в PR) от   airflow, о том что работа пакета проверена в тестовой среде. Approve пулл реквеста - за ответственным администратором     
Администраторы имеют соответствующие роли в системе контроля версий и airflow  
Все взаимодействие - обмен векхуками между контролем версий и airflow. Операции обновления продуктовой среды согласует ответственный системный администратор.  
Предложение об обновлении продуктовой среды (PR) инициирует airflow по результату отработки процессов: получения новых версий, сохранения их в хранилище,   разворот на тестовом окружении, тестирование.  
Для хранения информации о доступных пакетах, конфигурвциях ПО, текущих конфигурациях использовать субд Postgresql  
Сами процессы как DAG airflow. Сложная логика процессов реализуется на Python как и сами DAG. Храним в контроле версий, ролевая модель доступа   администраторов к DAG своих сервисов.
В приватную подсеть все. Доступ наружу через NAT. Если нужен доступ к интерфейсу Airflow, - то вебкомпонент размещаем в публичную подсеть
Зоны ответственности:  
продуктовая команда (пк): создание начального списка пакетов (п.2) обновления и совместную работу которых нужно начать отслеживать  
системный администратор (са) : заводит и мэйнтейнит DAG мониторинга новых версий и сохраниения локально для вновь созданного списка пакетов (п2.)  
системный администратор (са) : заводит и мейнтейнит DAG для обновления конфигурации списка пакетов (п.2) когда появляется новая версия.   
(пк) : согласует (approve PR) новый цикл тестирования при образовании новой конфигурации спсика пакетов (деплой в тестовую среду)  
(пк) : сщгласует (approve PR) деплой в прод протестированной в тестовой среде конфигурации  
